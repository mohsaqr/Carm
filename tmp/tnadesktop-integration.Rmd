---
title: "Carm → tna-desktop Integration: Statistics Tab — LLM Implementation Brief"
author: "Implementation guide for autonomous LLM execution"
date: "2026-02-23"
output: html_document
---

## PURPOSE

This document is a self-contained brief for an LLM to implement the Statistics tab
integration of the **Carm** statistical library into **tna-desktop**. Read every section
before writing a single line of code. All file paths, exact code, and verification
steps are included. Do NOT deviate from the patterns established by existing files.

---

## PROJECT LOCATIONS

| Repo | Local path |
|------|-----------|
| **Carm** (stat library) | `/Users/mohammedsaqr/Library/CloudStorage/GoogleDrive-saqr@saqr.me/My Drive/Git/JStats` |
| **tna-desktop** | `/Users/mohammedsaqr/Downloads/tnadesktop-main` |

**Carm branch:** `dev-clean` — all changes stay on this branch. Do NOT touch `main`.

**tna-desktop** is currently a local zip-extracted folder (not a git repo in Downloads).
Apply changes there directly.

---

## STACK FACTS (read before writing any code)

### Carm (JStats)
- TypeScript, Vite, `strict: true`
- `src/stats/analyze.ts` — exports `analyze()` and `detectFieldType()`
- `src/core/types.ts` — exports `AnalysisResult`, `NumericField`, `GroupField`, `FieldType`
- Both exported via root `src/index.ts` → `dist/index.js` (ESM) after `vite build`
- **`package.json` already has `"prepare": "tsup"`** — no change needed; `tsup` builds the dist correctly

### tna-desktop
- Tauri 2 + Vite + TypeScript, `strict: true`, no React/Vue
- Each tab = one `render*Tab(container: HTMLElement): void` function in `src/views/`
- `src/views/dashboard.ts` dispatches via switch on `state.activeSubTab`
- `state.rawData: string[][]` — ALL values are strings (CSV rows)
- `state.headers: string[]` — column names
- `addPanelDownloadButtons(panel, { csv, filename })` from `src/views/export.ts` — adds CSV/PNG buttons to `.panel-title`
- `downloadTableAsCsv(container, filename)` from `src/views/export.ts` — downloads first `<table>` inside container
- Panel HTML pattern:
  ```html
  <div class="panel">
    <div class="panel-title">Title here</div>
    <!-- content -->
  </div>
  ```
- Table CSS class: `preview-table` (already styled in CSS)
- No D3 needed for tables — build with `innerHTML` string templates

---

## TASK 0 — Verify Carm `prepare` script (already done)

**File:** `/Users/mohammedsaqr/Library/CloudStorage/GoogleDrive-saqr@saqr.me/My Drive/Git/JStats/package.json`

Verify the `"scripts"` block already contains:
```json
"prepare": "tsup",
"build": "tsup",
```

**`tsup`** (not `vite build`) is the library bundler — it produces `dist/index.js`, `dist/index.cjs`, and `.d.ts` files. The `prepare` script runs automatically on `npm install`, so `npm install github:mohsaqr/Carm#dev-clean` will build the dist. **No change needed.** Proceed to Task 1.

---

## TASK 1 — Add Carm dependency to tna-desktop

**File:** `/Users/mohammedsaqr/Downloads/tnadesktop-main/package.json`

Add to `"dependencies"`:
```json
"carm": "github:mohsaqr/Carm#dev-clean"
```

Result:
```json
"dependencies": {
  "@tauri-apps/api": "^2.5.0",
  "@tauri-apps/plugin-dialog": "^2.2.1",
  "@tauri-apps/plugin-fs": "^2.2.0",
  "carm": "github:mohsaqr/Carm#dev-clean",
  "d3": "^7.9.0",
  "html2canvas": "^1.4.1",
  "jspdf": "^2.5.2",
  "papaparse": "^5.5.2",
  "tnaj": "file:/Users/mohammedsaqr/Documents/Git/tna-js",
  "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.3/xlsx-0.20.3.tgz"
}
```

Then run:
```bash
cd /Users/mohammedsaqr/Downloads/tnadesktop-main
npm install
```

This triggers Carm's `prepare` script, builds the dist, installs it.

---

## TASK 2 — Create `src/views/statistics.ts`

**File to create:** `/Users/mohammedsaqr/Downloads/tnadesktop-main/src/views/statistics.ts`

Write the COMPLETE file below — do not paraphrase or summarize, write it exactly:

```typescript
/**
 * Statistics tab: field-based analysis powered by Carm.
 * Reads state.rawData / state.headers directly. No TNA model required.
 */
import { analyze, detectFieldType } from 'carm';
import type { AnalysisResult, FieldType } from 'carm';
import { state } from '../main';
import { addPanelDownloadButtons } from './export';

// ─── Force-test options ──────────────────────────────────────────────────────
const FORCE_OPTIONS: { value: string; label: string }[] = [
  { value: '',                  label: 'Auto (Shapiro-Wilk routing)' },
  { value: 't-test-independent',label: 'Independent t-test (Welch)' },
  { value: 't-test-paired',     label: 'Paired t-test' },
  { value: 'mann-whitney',      label: 'Mann-Whitney U' },
  { value: 'wilcoxon',          label: 'Wilcoxon signed-rank' },
  { value: 'one-way-anova',     label: 'One-way ANOVA' },
  { value: 'kruskal-wallis',    label: 'Kruskal-Wallis' },
  { value: 'chi-square',        label: 'Chi-square' },
  { value: 'fisher',            label: "Fisher's exact" },
];

// ─── Public entry point ───────────────────────────────────────────────────────

export function renderStatisticsTab(container: HTMLElement): void {
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'panels-grid';
  container.appendChild(grid);

  // Guard: no data loaded yet
  if (state.rawData.length === 0 || state.headers.length === 0) {
    const msg = document.createElement('div');
    msg.className = 'panel';
    msg.style.cssText = 'text-align:center;color:#888;padding:40px;font-size:14px';
    msg.textContent = 'No data loaded. Load a dataset first using the Load Data panel.';
    grid.appendChild(msg);
    return;
  }

  // ── Config panel ────────────────────────────────────────────────────────────
  const configPanel = document.createElement('div');
  configPanel.className = 'panel';
  configPanel.innerHTML = '<div class="panel-title">Configure Analysis</div>';

  configPanel.appendChild(makeColumnSelector('Outcome variable (numeric)', 'stats-outcome'));
  configPanel.appendChild(makeColumnSelector('Predictor / grouping column', 'stats-predictor'));

  // Paired checkbox
  const pairedWrap = document.createElement('div');
  pairedWrap.style.cssText = 'margin-bottom:14px;display:flex;align-items:center;gap:8px';
  pairedWrap.innerHTML =
    '<input type="checkbox" id="stats-paired" style="cursor:pointer">' +
    '<label for="stats-paired" style="font-size:13px;cursor:pointer">Paired samples (matched observations)</label>';
  configPanel.appendChild(pairedWrap);

  // Force-test dropdown
  const forceWrap = document.createElement('div');
  forceWrap.style.cssText = 'margin-bottom:18px';
  forceWrap.innerHTML =
    '<label for="stats-force" style="display:block;font-size:13px;font-weight:600;margin-bottom:4px;color:#444">Force test (optional)</label>' +
    '<select id="stats-force" style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff">' +
    FORCE_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('') +
    '</select>';
  configPanel.appendChild(forceWrap);

  // Run button
  const runBtn = document.createElement('button');
  runBtn.textContent = 'Run Analysis';
  runBtn.style.cssText =
    'padding:9px 22px;background:#667eea;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.15s';
  runBtn.addEventListener('mouseover', () => { runBtn.style.background = '#5a6fd6'; });
  runBtn.addEventListener('mouseout',  () => { runBtn.style.background = '#667eea'; });
  configPanel.appendChild(runBtn);

  const errorMsg = document.createElement('div');
  errorMsg.style.cssText = 'margin-top:10px;color:#dc3545;font-size:13px;display:none';
  configPanel.appendChild(errorMsg);

  grid.appendChild(configPanel);

  // ── Results panel (hidden until run) ────────────────────────────────────────
  const resultsPanel = document.createElement('div');
  resultsPanel.className = 'panel';
  resultsPanel.style.display = 'none';
  grid.appendChild(resultsPanel);

  // ── Run handler ──────────────────────────────────────────────────────────────
  runBtn.addEventListener('click', () => {
    errorMsg.style.display = 'none';
    resultsPanel.style.display = 'none';

    const outcomeCol   = (document.getElementById('stats-outcome')  as HTMLSelectElement).value;
    const predictorCol = (document.getElementById('stats-predictor') as HTMLSelectElement).value;
    const paired       = (document.getElementById('stats-paired')   as HTMLInputElement).checked;
    const forceTest    = (document.getElementById('stats-force')    as HTMLSelectElement).value || undefined;

    if (!outcomeCol)   { showErr('Select an outcome variable.'); return; }
    if (!predictorCol) { showErr('Select a predictor column.'); return; }

    const outcomeIdx   = state.headers.indexOf(outcomeCol);
    const predictorIdx = state.headers.indexOf(predictorCol);

    // Build aligned pairs — skip rows where outcome doesn't parse as a finite number
    const pairs = state.rawData
      .map(row => ({ num: parseFloat(row[outcomeIdx] ?? ''), label: String(row[predictorIdx] ?? '') }))
      .filter(p => isFinite(p.num));

    if (pairs.length < 4) {
      showErr('Need at least 4 valid numeric rows in the outcome column.');
      return;
    }

    const numericVals = pairs.map(p => p.num);
    const labels      = pairs.map(p => p.label);

    // Detect predictor field type from string values
    const predFt = detectFieldType(labels) as FieldType;
    if (predFt === 'numeric') {
      showErr(
        'Predictor column appears numeric. For group comparison the predictor must be ' +
        'binary or categorical (e.g. "A"/"B" or condition labels).'
      );
      return;
    }

    try {
      const result = analyze(
        { type: 'numeric',                            name: outcomeCol,   values: numericVals },
        { type: predFt as 'binary' | 'categorical',  name: predictorCol, values: labels      },
        { paired, forceTest }
      );
      renderResults(resultsPanel, result);
      resultsPanel.style.display = '';
    } catch (err) {
      showErr(err instanceof Error ? err.message : String(err));
    }
  });

  function showErr(msg: string): void {
    errorMsg.textContent = msg;
    errorMsg.style.display = 'block';
  }
}

// ─── Column selector with type badge ─────────────────────────────────────────

function makeColumnSelector(labelText: string, id: string): HTMLElement {
  const wrap = document.createElement('div');
  wrap.style.cssText = 'margin-bottom:14px';

  const lbl = document.createElement('label');
  lbl.htmlFor = id;
  lbl.style.cssText = 'display:block;font-size:13px;font-weight:600;margin-bottom:4px;color:#444';
  lbl.textContent = labelText;

  const row = document.createElement('div');
  row.style.cssText = 'display:flex;align-items:center;gap:10px';

  const sel = document.createElement('select');
  sel.id = id;
  sel.style.cssText = 'flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff';

  const empty = document.createElement('option');
  empty.value = '';
  empty.textContent = '── select column ──';
  sel.appendChild(empty);

  for (const h of state.headers) {
    const opt = document.createElement('option');
    opt.value = h;
    opt.textContent = h;
    sel.appendChild(opt);
  }

  const badge = document.createElement('span');
  badge.id = `${id}-badge`;
  badge.style.cssText =
    'font-size:11px;padding:2px 8px;border-radius:10px;background:#eee;color:#666;' +
    'white-space:nowrap;min-width:90px;text-align:center';
  badge.textContent = '—';

  sel.addEventListener('change', () => updateBadge(sel.value, badge, id));

  row.appendChild(sel);
  row.appendChild(badge);
  wrap.appendChild(lbl);
  wrap.appendChild(row);
  return wrap;
}

function updateBadge(colName: string, badge: HTMLElement, _id: string): void {
  if (!colName) {
    badge.textContent = '—';
    badge.style.background = '#eee';
    badge.style.color = '#666';
    return;
  }
  const colIdx = state.headers.indexOf(colName);
  const rawVals = state.rawData.map(row => row[colIdx] ?? '');
  // Pre-parse: if all non-empty values are finite numbers, pass as numbers
  const parsedVals: (string | number)[] = rawVals.map(v => {
    const n = parseFloat(v);
    return isFinite(n) ? n : v;
  });
  const ft = detectFieldType(parsedVals);
  const colors: Record<string, { bg: string; fg: string }> = {
    numeric:     { bg: '#d4edda', fg: '#155724' },
    binary:      { bg: '#cce5ff', fg: '#004085' },
    categorical: { bg: '#fff3cd', fg: '#856404' },
    ordinal:     { bg: '#e2d9f3', fg: '#4a1b9a' },
  };
  const c = colors[ft] ?? { bg: '#eee', fg: '#666' };
  badge.textContent = ft;
  badge.style.background = c.bg;
  badge.style.color = c.fg;
}

// ─── Results renderer ─────────────────────────────────────────────────────────

function renderResults(panel: HTMLElement, r: AnalysisResult): void {
  panel.innerHTML = '<div class="panel-title">Results</div>';

  // Test name + APA-formatted string
  const header = document.createElement('div');
  header.style.cssText = 'margin-bottom:18px';
  header.innerHTML =
    `<div style="font-size:16px;font-weight:700;color:#333;margin-bottom:6px">${r.test}</div>` +
    `<div style="font-family:monospace;font-size:13px;background:#f8f9fa;border:1px solid #e9ecef;` +
    `border-radius:6px;padding:10px 14px;color:#333;line-height:1.6">${r.result.formatted}</div>`;
  panel.appendChild(header);

  // Key stats inline
  const statsRow = document.createElement('div');
  statsRow.style.cssText = 'display:flex;gap:20px;margin-bottom:18px;flex-wrap:wrap';
  statsRow.innerHTML =
    `<span style="font-size:13px;color:#555"><b>n</b> = ${r.result.n}</span>` +
    `<span style="font-size:13px;color:#555"><b>p</b> = ${fmtP(r.result.pValue)}</span>` +
    `<span style="font-size:13px;color:#555">` +
    `<b>${r.result.effectSize.name}</b> = ${r.result.effectSize.value.toFixed(3)} ` +
    `<span style="color:#888">(${r.result.effectSize.interpretation})</span></span>`;
  panel.appendChild(statsRow);

  // Descriptives table
  if (r.descriptives && r.descriptives.length > 0) {
    const groupLabels = r.normality?.map(n => n.group)
      ?? r.descriptives.map((_, i) => `Group ${i + 1}`);

    let html =
      '<div style="font-size:13px;font-weight:700;color:#444;margin-bottom:6px">Descriptive Statistics</div>' +
      '<table class="preview-table" style="font-size:12px;width:100%"><thead><tr>' +
      '<th>Group</th><th>n</th><th>M</th><th>SD</th><th>SE</th><th>95% CI</th>' +
      '</tr></thead><tbody>';

    for (let i = 0; i < r.descriptives.length; i++) {
      const d = r.descriptives[i]!;
      const lbl = groupLabels[i] ?? `Group ${i + 1}`;
      html +=
        `<tr><td style="font-weight:600">${lbl}</td>` +
        `<td>${d.n}</td>` +
        `<td>${d.mean.toFixed(3)}</td>` +
        `<td>${d.sd.toFixed(3)}</td>` +
        `<td>${d.se.toFixed(3)}</td>` +
        `<td>[${d.ci[0].toFixed(3)}, ${d.ci[1].toFixed(3)}]</td></tr>`;
    }
    html += '</tbody></table>';

    const descDiv = document.createElement('div');
    descDiv.style.marginBottom = '18px';
    descDiv.innerHTML = html;
    panel.appendChild(descDiv);
  }

  // Normality row (informational)
  if (r.normality && r.normality.length > 0) {
    const normDiv = document.createElement('div');
    normDiv.style.cssText =
      'font-size:12px;color:#666;background:#f8f9fa;padding:8px 12px;' +
      'border-radius:6px;margin-bottom:14px;line-height:1.7';
    normDiv.innerHTML =
      '<b>Normality check (Shapiro-Wilk, used for auto-routing):</b><br>' +
      r.normality
        .map(n => `${n.group}: W = ${n.W.toFixed(3)}, p = ${fmtP(n.p)}`)
        .join('  ·  ');
    panel.appendChild(normDiv);
  }

  // Post-hoc table
  if (r.posthoc && r.posthoc.length > 0) {
    let html =
      '<div style="font-size:13px;font-weight:700;color:#444;margin-bottom:6px">Post-hoc Pairwise Comparisons</div>' +
      '<table class="preview-table" style="font-size:12px;width:100%"><thead><tr>' +
      '<th>Group 1</th><th>Group 2</th><th>Δ Mean</th><th>p</th><th>p (adj)</th><th></th>' +
      '</tr></thead><tbody>';

    for (const ph of r.posthoc) {
      const sig = ph.pValueAdj < 0.001 ? '***'
                : ph.pValueAdj < 0.01  ? '**'
                : ph.pValueAdj < 0.05  ? '*'
                : 'ns';
      const sigColor = sig !== 'ns' ? '#155724' : '#aaa';
      html +=
        `<tr>` +
        `<td>${ph.group1}</td>` +
        `<td>${ph.group2}</td>` +
        `<td>${ph.meanDiff.toFixed(3)}</td>` +
        `<td>${fmtP(ph.pValue)}</td>` +
        `<td>${fmtP(ph.pValueAdj)}</td>` +
        `<td style="font-weight:700;color:${sigColor}">${sig}</td>` +
        `</tr>`;
    }
    html += '</tbody></table>';

    const phDiv = document.createElement('div');
    phDiv.style.marginBottom = '14px';
    phDiv.innerHTML = html;
    panel.appendChild(phDiv);
  }

  // CSV download button (downloads the first table in the panel)
  addPanelDownloadButtons(panel, { csv: true, filename: 'statistics-results' });
}

// ─── Helpers ──────────────────────────────────────────────────────────────────

function fmtP(p: number): string {
  if (!isFinite(p)) return 'N/A';
  if (p < 0.001) return '< .001';
  return p.toFixed(3).replace('0.', '.');
}
```

---

## TASK 3 — Edit `src/views/dashboard.ts`

**File:** `/Users/mohammedsaqr/Downloads/tnadesktop-main/src/views/dashboard.ts`

Make 7 precise edits. Read the file first to confirm exact whitespace before applying.

### Edit 3a — Add import (after the last existing import, around line 30)

Find this line:
```typescript
import { renderLoadPanel } from './load-data';
```

Add immediately after it:
```typescript
import { renderStatisticsTab } from './statistics';
```

### Edit 3b — Add to SINGLE_TABS array

Find:
```typescript
  { id: 'indices', label: 'Sequence Indices' },
];

const GROUP_TABS
```

Replace with:
```typescript
  { id: 'indices',     label: 'Sequence Indices' },
  { id: 'statistics',  label: 'Statistics' },
];

const GROUP_TABS
```

### Edit 3c — Add to GROUP_TABS array

Find:
```typescript
  { id: 'compare-networks', label: 'Compare Networks' },
];

const ONEHOT_TABS
```

Replace with:
```typescript
  { id: 'compare-networks', label: 'Compare Networks' },
  { id: 'statistics',       label: 'Statistics' },
];

const ONEHOT_TABS
```

### Edit 3d — Add to ONEHOT_TABS array

Find:
```typescript
  { id: 'bootstrap', label: 'Bootstrap Validation' },
];

const GROUP_ONEHOT_TABS
```

Replace with:
```typescript
  { id: 'bootstrap',  label: 'Bootstrap Validation' },
  { id: 'statistics', label: 'Statistics' },
];

const GROUP_ONEHOT_TABS
```

### Edit 3e — Add to GROUP_ONEHOT_TABS array

Find:
```typescript
  { id: 'compare-networks', label: 'Compare Networks' },
];

// ─── Cached model data
```

Replace with:
```typescript
  { id: 'compare-networks', label: 'Compare Networks' },
  { id: 'statistics',       label: 'Statistics' },
];

// ─── Cached model data
```

### Edit 3f — Add to single/onehot switch in `updateTabContent()`

Find this block (inside the `if (mode === 'single' || mode === 'onehot')` switch):
```typescript
      case 'indices':
        renderIndicesTab(content, model);
        break;
    }
  } else {
```

Replace with:
```typescript
      case 'indices':
        renderIndicesTab(content, model);
        break;
      case 'statistics':
        renderStatisticsTab(content);
        break;
    }
  } else {
```

### Edit 3g — Add to group/clustering switch in `updateTabContent()`

Find this block (inside the `else` branch of `updateTabContent()`):
```typescript
      case 'compare-networks':
        if (activeGroupFullModel) renderCompareNetworksTab(content, activeGroupFullModel);
        break;
    }
  }
}
```

Replace with:
```typescript
      case 'compare-networks':
        if (activeGroupFullModel) renderCompareNetworksTab(content, activeGroupFullModel);
        break;
      case 'statistics':
        renderStatisticsTab(content);
        break;
    }
  }
}
```

---

## VERIFICATION

Run these commands IN ORDER:

```bash
# 1. Confirm Carm builds cleanly
cd "/Users/mohammedsaqr/Library/CloudStorage/GoogleDrive-saqr@saqr.me/My Drive/Git/JStats"
npm run build
# Expected: no errors, dist/ updated

# 2. Confirm Carm tests still pass
NODE_OPTIONS='--max-old-space-size=4096' npx vitest run
# Expected: 309/309 (or more) passing

# 3. Install in tna-desktop
cd /Users/mohammedsaqr/Downloads/tnadesktop-main
npm install
# Expected: carm installed from github:mohsaqr/Carm#dev-clean

# 4. Type-check tna-desktop
npx tsc --noEmit
# Expected: 0 errors

# 5. Dev build
npm run dev
# Load a CSV → go to Statistics tab → select columns → Run Analysis
```

### Manual smoke test checklist
- [ ] Statistics tab appears in the tab bar (all modes)
- [ ] "No data loaded" message when no CSV is loaded
- [ ] Column selectors populate from `state.headers` after loading CSV
- [ ] Type badges update on column selection (numeric=green, binary=blue, categorical=yellow)
- [ ] 2-group numeric+binary CSV → Welch t-test or Mann-Whitney result shown
- [ ] 3-group numeric+categorical CSV → ANOVA + post-hoc table visible
- [ ] Skewed 3-group data → Kruskal-Wallis + Dunn post-hoc
- [ ] Normality row explains routing decision
- [ ] CSV download button appears and downloads correct data
- [ ] Error shown for non-numeric outcome column

---

## KNOWN GOTCHAS

1. **`state.rawData` is all strings** — `detectFieldType()` receives strings for predictor columns
   (correct), but for the badge on the outcome column, values are pre-parsed to numbers first
   (see `updateBadge()` in statistics.ts). Do not skip this pre-parsing step.

2. **`prepare` script** — Without it, `npm install github:mohsaqr/Carm#dev-clean` installs source
   TypeScript only, not the compiled dist. The `prepare` script runs `vite build` automatically.

3. **`exactOptionalPropertyTypes: true`** in Carm's tsconfig — If you add any new code that
   returns `AnalysisResult`, use `...(x !== undefined && { x })` spread, not `x: undefined`.

4. **`addPanelDownloadButtons` requires `.panel-title`** — The panel must have a child
   `<div class="panel-title">` for the download buttons to attach. The current statistics.ts
   implementation includes this correctly.

5. **Tab available before model is built** — The statistics tab reads `state.rawData` directly,
   so it works even when no TNA model has been built. It will show "No data loaded" if
   `state.rawData` is empty (before any CSV is loaded).

6. **Carm branch** — The dependency points to `dev-clean`. Do not merge `dev-clean` to `main`
   without the user's explicit instruction.
